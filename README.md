# platform-automation-example
Example Repository for using platform-automation

The structure of this repository allows for multiple environments to be represented in a single repository

## environments

folder holds the configuration for a given deployment where there is a subfolder for a given iaas and environment name.  `IaaS` folder would likely be optional

### Configuration

Within each iaas/foundation name folder there would be multiple folders

* `defaults` - this folder contains the default values for a given tile.  This is generated by `om config-template` **Promotable**

* `templates` - this folder contains the resulting interpolated template based on operations files that have been applied to the output of `om config-template`.  This is created by `scripts/generate-config.sh` **Promotable**

* `vars` - this folder contains environment specific variables per product that is being deployed. **Not Promotable**

* `secrets` - this folder contains the templates that can be interpolated using `credhub interpolate` to be used as secrets inputs to other tasks **Promotable**

* `versions` - this folder contains both the product version and stemcell version per product. **Promotable**

* `errands` - this folder contains a file with a list of errand names to run per product.  Ideally this would be a proper yaml file but for now easier to read errand names via bash.  Used by `run-errands` task in `proposed-tasks`

## State

Used to store opsmanager state.yml file leveraged by create-vm task.  Folder structure mimics environment <iaas>/<environment name>

## Proposed Tasks

* `apply-product-changes` - task to allow specifying selective deploy for a single product

* `download-create-opsman` this task is an aggregate that will try to short-circuit and not download opsmanager if state file has content otherwise with download opsmanager via `om download-product` and create it via `p-automator create-vm`

* `download-upgrade-opsman` this task is an aggregate that will short-circuit and not download opsmanager if the version installed is the version expected.  This optimization only works in 2.5.x due to how opsmanager versioning worked prior to 2.5.x.  If version mismatches it will download product via `om download-product` and update vm via `p-automator upgrade-opsman`

* `download-stage-tile-stemcell` this task is an aggregrate that will only download the tile if that version is not already staged.  It will also only download the expected stemcell if that version hasn't already been uploaded.  Otherwise it will download both tile and stemcell using `om download-product`, upload tile and stemcell, stage tile and assign the specified stemcell version to the tile (always regardless of download)

* `make-commit` - this task avoids committing state.yml using `porcelain` option, PR has been accepted so this task will be replace with platform-automation task once it's shipped

* `run-errand` - The approach here disables all errands from being ran in the apply-changes flow and then will run them directly via bosh to allow running errands after apply-changes for a given product has succeeded in the pipeline while the next tile is being deployed.

## Scripts

This contains 2 scripts.
* `generate-config.sh <product-name>` - this script uses `om config-template` to generate configuration yaml configuration, defaults, etc applying operations lies in <product>-operations.  Currently places the results in the first enviroment `environents/vsphere/dev/config`

* `validate-config.sh <product-name>` - this script validates that all properties that are needed to interpolate the template in `environents/vsphere/dev/config/templates/<product-name>.yml` This uses vars files from `environents/vsphere/dev/config/defaults/<product-name>.yml`, `environents/vsphere/dev/config/vars/<product-name>.yml`, `environents/vsphere/dev/config/secrets/<product-name>.yml`


## TODO

- Expand example to show global defaults (things like `security_acknowledgement: X` in cf.yml)
- Expand example to have iaas default vars
- Expand example to have environment type default vars (for situations where there are multiple productions as an example)
